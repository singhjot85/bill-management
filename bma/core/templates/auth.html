{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    <link rel="icon" type="image/png" href="{% static 'favicons/favicon.png' %}">
    <title id="page-title">Login</title>
</head>
<body>
    <div class="auth-container">
        <h2 id="form-title">Login</h2>
        <form method="post" id="auth-form" class="auth-form">
            {% csrf_token %}
            {{ form.as_table }}

            <!-- <input type="hiddem" name="mode" value="login"> -->
            <button type="submit" id="submit-button">Login</button>
        </form>

        <p id="toggle-text">
            Don't have an account?
            <a href="#" onclick="toggleMode(event)" id="inner-toggle-text">Register</a>
        </p>
    </div>

    <script>
        let currentMode = "{{ mode }}";

        async function fetchAuthForm(newMode) {
            try{
                url = `?mode=${newMode}`
                const response = await fetch(
                    url, 
                    { 
                        headers:  { 'X-Requested-With': 'XMLHttpRequest' } 
                    }
                );
                if (!response.ok) throw new Error("Failed to load form");

                // Fetch form from html template
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = await response.text();;
                const newForm = tempDiv.querySelector('form#auth-form');
                if (!newForm) throw new Error("Form not found in response");
                
                // Replace current form with one from backend
                document.getElementById('auth-form').replaceWith(newForm);
            } catch(err) {
                console.error("Error updating form:", err);
                alert("Failed to load form. Please try again.");
            }
        }
        async function toggleMode(e) {
            e.preventDefault();
            const formContainer = document.getElementById('auth-form').parentElement;
            
            currentMode = (currentMode ==="login" ? "register": "login");
            await fetchAuthForm(currentMode);

            const formTitle = document.getElementById('form-title');
            const pageTitle = document.getElementById('page-title');
            const innerToggleText = document.getElementById('inner-toggle-text');
            const submitButton = document.getElementById('submit-button');
            if (currentMode === "register") {
                formTitle.textContent = "Register";
                pageTitle.textContent = "Register";
                submitButton.innerHTML = "Register";
                innerToggleText.innerHTML = "Login";
            } else {
                formTitle.textContent = "Login";
                pageTitle.textContent = "Login";
                submitButton.innerHTML = "Login";
                innerToggleText.innerHTML = "Register";
            }
        }
        // Append current mode before submit
        document.getElementById("auth-form").addEventListener('submit', function (e) {
            const modeField = document.createElement('input');
            modeField.type = 'hidden';
            modeField.name = 'mode';
            modeField.value = currentMode;
            this.appendChild(modeField)
        })
    </script>

</body>
</html>
